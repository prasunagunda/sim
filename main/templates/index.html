<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Speedtest</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
        body{font-family:Arial;background:#0b1220;color:white;text-align:center;padding:20px;}
        .card{max-width:420px;margin:auto;background:#111a2e;padding:20px;border-radius:16px;}
        .netbox{background:#eaffea;color:#0c4a0c;padding:12px;border-radius:12px;font-weight:bold;margin:15px 0;}
        button{width:100%;padding:12px;font-size:18px;border:none;border-radius:12px;background:#00c2ff;font-weight:bold;}
        button:disabled{background:gray;}
        .box{margin-top:15px;font-size:18px;line-height:1.8;}
        .small{color:#aaa;font-size:14px;}
    </style>
</head>
<body>

<div class="card">
    <h2>üì∂ Speedtest</h2>
    <p class="small">Click Run to test your current Internet speed.</p>

    <div class="netbox">
        üì° Current Connected Network: <span id="net">Loading...</span>
    </div>

    <button id="btn" onclick="runTest()">üöÄ Run Speed Test</button>
    <div class="box" id="out">Status: Ready ‚úÖ</div>
</div>

<script>
async function loadNetwork(){
    try{
        // call the network API
        let res = await fetch("/network/?t=" + Date.now());
        let data = await res.json();

        // choose display name: prefer ISP (Jio/ACT/etc) then server SSID then fallback
        let networkName = "Unknown Network";
        if (data.isp && data.isp !== "Private Network (LAN)" && data.isp !== "Unknown" && data.lookup_status === "success") {
            networkName = data.isp;
        } else if (data.server_ssid && data.server_ssid !== "Server-Network-Unknown") {
            networkName = data.server_ssid;
        } else if (data.isp) {
            // show "Private Network (LAN)" for local connections
            networkName = data.isp;
        }

        document.getElementById("net").innerText = networkName;
    }catch(e){
        document.getElementById("net").innerText = "Network Error";
        console.error(e);
    }
}

async function runTest(){
    document.getElementById("btn").disabled = true;
    document.getElementById("out").innerText = "‚è± Testing... this can take 20‚Äì60s";

    // refresh network name before running the test
    await loadNetwork();

    try {
        let res = await fetch("/speedtest/");
        let data = await res.json();

        if (data.status === "success") {
            document.getElementById("out").innerHTML =
                "‚úÖ Completed<br>" +
                "‚¨á Download: <b>" + data.download_mbps + " Mbps</b><br>" +
                "‚¨Ü Upload: <b>" + data.upload_mbps + " Mbps</b><br>" +
                "üìç Ping: <b>" + data.ping_ms + " ms</b><br>" +
                "üïí Time: " + data.time;
        } else {
            document.getElementById("out").innerText = "‚ùå Failed: " + (data.error || JSON.stringify(data));
        }
    } catch (err) {
        document.getElementById("out").innerText = "‚ùå Request error";
        console.error(err);
    } finally {
        document.getElementById("btn").disabled = false;
    }
}

// initial load and periodic refresh of network name
loadNetwork();
setInterval(loadNetwork, 5000);
</script>

</body>
</html>
